<!-- templates/fantasy_nba/show_ratings.html -->
{% extends 'fantasy_nba/base.html' %}
{% load static %}
{% load extras %}
{% load fantasy_nba_tags %}
{% block content %}
<!DOCTYPE html>
<style>
    .column-hidden-player-id {
        display: none !important; /* !important to help ensure it overrides other styles if necessary */
    }
</style>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Player Ratings</h2>
    </div>

    {% if active_team or punt_categories_string %}
    <div id="team-info-container" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; font-size: 0.9em;">
        {% if active_team %}
        <div style="margin-bottom: 5px;">
            <strong>Missing positions:</strong> <span id="position-coverage-text">{{ team_coverage_string|default:"Calculating..." }}</span>
        </div>
        {% endif %}
        {% if punt_categories_string %}
        <div>
            {{ punt_categories_string }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="table-controls" style="margin-bottom: 15px; display: flex; align-items: center; gap: 20px;">
        <form method="GET" action="{% url 'show_ratings' %}" id="filter-form" style="display: inline-block; margin-right: 20px;">
            <label for="status-filter">Filter by Status:</label>
            <select name="status_filter" id="status-filter" onchange="document.getElementById('filter-form').submit();">
                {% for value, display_name in status_filter_choices %}
                    <option value="{{ value }}" {% if current_status_filter == value %}selected{% endif %}>{{ display_name }}</option>
                {% endfor %}
            </select>
            {# Hidden fields to preserve sorting when filter changes #}
            {% if sort_by %}<input type="hidden" name="sort_by" value="{{ sort_by }}">{% endif %}
            {% if sort_direction %}<input type="hidden" name="sort_direction" value="{{ sort_direction }}">{% endif %}
            {# No explicit submit button needed if onchange submits the form #}
            {# <button type="submit">Filter</button> #}
        </form>
        <div>
            <label for="name-search">Search by Name:</label>
            <input type="text" id="name-search" placeholder="Enter player name...">
        </div>
        <form method="post" action="{% url 'toggle_categories' %}" id="toggle-categories-form" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary btn-sm">
                {% if show_categories %}Hide Categories{% else %}Show Categories{% endif %}
            </button>
            {% if data_last_updated %}
            <span style="font-size: 0.75em; color: #666; margin-left: 8px;">Data refreshed on {{ data_last_updated }}</span>
            {% endif %}
        </form>
        <button id="compare-players-btn" class="btn btn-primary btn-sm" style="margin-left: 10px;">
            Compare Players
        </button>
        {% if active_team %}
        <button id="set-draft-order-btn" class="btn btn-info btn-sm">
            Set Draft Positions
        </button>
        {% endif %}
    </div>

    <!-- Comparison Chart -->
    <div id="compare-container" style="display: none; margin: 20px auto; max-width: 600px; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0;">Player Comparison</h4>
            <button id="close-compare-btn" class="btn btn-sm btn-secondary">×</button>
        </div>
        <div id="compare-message" style="text-align: center; color: #666; margin: 20px 0;">
            Select 2 players to compare
        </div>
        <div id="chart-wrapper" style="display: none; position: relative; height: 400px; width: 100%;">
            <canvas id="compareChart"></canvas>
        </div>
    </div>

    <table id="ratings-table" class="styled-table">
        <thead>
            <tr>
                {% for column_key, display_name in column_display_names.items %}
                    {% if show_categories or column_key not in category_columns %}
                    <th class="{% if column_key == 'Player_ID' %}column-hidden-player-id{% endif %}">
                        <a href="{% url 'show_ratings' %}?sort_by={{ column_key }}&toggle=1{% if current_status_filter and current_status_filter != 'ALL' %}&status_filter={{ current_status_filter|urlencode }}{% endif %}">
                            {{ display_name }}
                            {% if sort_by == column_key and sort_direction == 'asc' %} ▲{% endif %}
                            {% if sort_by == column_key and sort_direction == 'desc' %} ▼{% endif %}
                        </a>
                    </th>
                    {% endif %}
                {% endfor %}
                <th>
                    {% if active_team %}
                        Actions
                    {% else %}
                        Tools
                    {% endif %}
                </th>
            </tr>
        </thead>
        <tbody id="ratings-table-body">
            {% if ratings|length == 0 %}
                <tr><td colspan="{{ column_display_names|length|add:'1' }}">No ratings available</td></tr>
            {% else %}
                {% for row in ratings %}
                {% with player_id_val=row|get_item:'Player_ID'|get_item:'value'|default_if_none:'' %}
                <tr data-player-id="{{ player_id_val }}">
                    {% for column_actual_name, column_display_name_val in column_display_names.items %}
                        {% if show_categories or column_actual_name not in category_columns %}
                        {% with cell_data=row|get_item:column_actual_name %}
                            <td data-column-key="{{ column_actual_name }}"
                                class="{% if cell_data.css_class %}
                                           {% if enable_heatmap and not column_actual_name|is_rating_column %}
                                               {{ cell_data.css_class }}
                                           {% elif enable_tier_colors and column_actual_name|is_rating_column %}
                                               {{ cell_data.css_class }}
                                           {% endif %}
                                       {% endif %}{% if column_actual_name == 'Status' %} player-status-cell{% endif %}{% if column_actual_name == 'Player_ID' %} column-hidden-player-id{% endif %}">
                                {% if column_actual_name == 'Draft_Pos' and active_team and player_id_val != 'TEAM_AVERAGE_ROW' %}
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <button class="draft-move-btn" data-player-id="{{ player_id_val }}" data-direction="up" style="padding: 0 5px; line-height: 1;">+</button>
                                        <span style="flex-grow: 1; text-align: center;">
                                            {{ cell_data.value|default:"N/A" }}
                                        </span>
                                        <button class="draft-move-btn" data-player-id="{{ player_id_val }}" data-direction="down" style="padding: 0 5px; line-height: 1;">-</button>
                                    </div>
                                {% elif player_id_val == 'TEAM_AVERAGE_ROW' and column_actual_name == "Name" %}
                                    {# 1. Bold Team Name #}
                                    <strong>{{ cell_data.value }}</strong>
                                {% elif column_actual_name == "Name" or column_actual_name == "Player_ID" or column_actual_name == "TEAM_ID" or column_actual_name == "Status" or column_actual_name == "POS" %}
                                    {{ cell_data.value }}
                                {% else %}
                                    {{ cell_data.value|floatformat:2|default:"N/A" }}
                                {% endif %}
                            </td>
                        {% endwith %}
                        {% endif %}
                    {% endfor %}
                    <td>
                        {% if player_id_val == 'TEAM_AVERAGE_ROW' %}
                            {# 3. Empty Actions cell for team average row #}
                            
                        {% else %}
                            {# Add a class to the forms for easier selection in JS #}
                            {% if user.is_authenticated and active_team %}
                                <!-- Button to set status to ON_TEAM -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="ON_TEAM">
                                    <button type="submit" title="Add to Team">+</button>
                                </form>
                                <!-- Button to set status to AVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="AVAILABLE">
                                    <button type="submit" title="Make Available">-</button>
                                </form>
                                <!-- Button to set status to UNAVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="UNAVAILABLE">
                                    <button type="submit" title="Make Unavailable">/</button>
                                </form>
                                <!-- Button to toggle comparison -->
                                <button class="compare-toggle-btn" 
                                        data-player-id="{{ player_id_val }}"
                                        title="Compare Player"
                                        style="{% if player_id_val in compare_player_ids %}background-color: #28a745; color: white;{% endif %}">
                                    C
                                </button>
                            {% else %}
                                <!-- Compare button for users without active team -->
                                <button class="compare-toggle-btn" 
                                        data-player-id="{{ player_id_val }}"
                                        title="Compare Player"
                                        style="{% if player_id_val in compare_player_ids %}background-color: #28a745; color: white;{% endif %}">
                                    C
                                </button>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            {% endif %}
        </tbody>
    </table>

    
</body>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function reloadWithoutToggle() {
                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('toggle')) {
                    currentUrl.searchParams.delete('toggle');
                    window.location.href = currentUrl.toString();
                } else {
                    window.location.reload();
                }
            }

            const forms = document.querySelectorAll('.update-status-form');

            forms.forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault(); // Prevent default page reload

                    const formData = new FormData(form);
                    const playerId = formData.get('player_id');
                    const newStatusValue = formData.get('status'); // This is 'ON_TEAM', 'AVAILABLE', etc.
                    const url = form.action;
                    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        body: formData, // FormData handles content type for you
                        headers: {
                            // 'X-CSRFToken': csrfToken, // FormData sends it, but good to be aware
                            // For non-FormData POSTs, you'd need:
                            // 'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Try to get error message from server if available
                            return response.json().then(errData => {
                                throw new Error(errData.error || `Server error: ${response.status}`);
                            }).catch(() => {
                                // Fallback if error response is not JSON
                                throw new Error(`Server error: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // The action was successful. Reload the page.
                            // The browser will use the current URL, including any filter
                            // and sorting parameters. The server will re-render the page
                            // with the correct data, causing the player to disappear
                            // if they no longer match the filter.
                            location.reload();
                        } else {
                            // Handle failure (e.g., display data.error)
                            alert('Error updating status: ' + (data.error || 'Unknown error'));
                            console.error('Error updating status:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('An error occurred: ' + error.message);
                    });
                });
            });

            // Draft Position Buttons
            const draftMoveButtons = document.querySelectorAll('.draft-move-btn');
            draftMoveButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();

                    const playerId = this.dataset.playerId;
                    const direction = this.dataset.direction;
                    const url = "{% url 'move_draft_pick' %}";
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    const formData = new FormData();
                    formData.append('player_id', playerId);
                    formData.append('direction', direction);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            reloadWithoutToggle();
                        } else {
                            alert('Error: ' + data.error);
                            console.error('Error moving draft pick:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('A network error occurred.');
                    });
                });
            });

            // Name Search Functionality
            const nameSearchInput = document.getElementById('name-search');
            const ratingsTableBody = document.getElementById('ratings-table-body');
            const allRows = ratingsTableBody.getElementsByTagName('tr');

            nameSearchInput.addEventListener('keyup', function() {
                const searchTerm = nameSearchInput.value.toLowerCase();

                for (let i = 0; i < allRows.length; i++) {
                    const row = allRows[i];
                    const playerIdVal = row.getAttribute('data-player-id');

                    // Always show the team average row if it exists
                    if (playerIdVal === 'TEAM_AVERAGE_ROW') {
                        row.style.display = ''; // Ensure it's visible
                        continue;
                    }

                    const nameCell = row.querySelector('td[data-column-key="Name"]');
                    if (nameCell) {
                        const nameText = nameCell.textContent.toLowerCase();
                        row.style.display = nameText.includes(searchTerm) ? '' : 'none';
                    }
                }
            });

            // Set Draft Order Button
            const setDraftOrderBtn = document.getElementById('set-draft-order-btn');
            if (setDraftOrderBtn) {
                setDraftOrderBtn.addEventListener('click', function() {
                    const visiblePlayerIds = [];
                    const allVisibleRows = ratingsTableBody.querySelectorAll('tr');

                    allVisibleRows.forEach(row => {
                        // Check if the row is currently visible (not display: none)
                        if (row.style.display !== 'none') {
                            const playerId = row.getAttribute('data-player-id');
                            if (playerId && playerId !== 'TEAM_AVERAGE_ROW') {
                                visiblePlayerIds.push(playerId);
                            }
                        }
                    });

                    const url = "{% url 'set_draft_order' %}";
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    const formData = new FormData();
                    visiblePlayerIds.forEach(id => formData.append('player_order[]', id));
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            reloadWithoutToggle(); // Reload to see the new draft positions
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
                });
            }

            // Toggle Categories Button
            const toggleCategoriesForm = document.getElementById('toggle-categories-form');
            if (toggleCategoriesForm) {
                toggleCategoriesForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent the default form submission

                    const url = this.action;
                    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to reflect the change
                            window.location.reload();
                        } else {
                            alert('Error toggling categories: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => console.error('Error toggling categories:', error));
                });
            }

            // ============ COMPARE PLAYERS FUNCTIONALITY ============
            let compareChart = null;
            
            // Handle compare toggle buttons (C button)
            document.querySelectorAll('.compare-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const playerId = this.dataset.playerId;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch("{% url 'toggle_compare' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `player_id=${playerId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Toggle button visual state
                            if (data.is_comparing) {
                                this.style.backgroundColor = '#28a745';
                                this.style.color = 'white';
                            } else {
                                this.style.backgroundColor = '';
                                this.style.color = '';
                            }
                            // If compare container is open, refresh the chart
                            if (compareContainer.style.display === 'block') {
                                loadCompareData();
                            }
                        } else if (data.error) {
                            alert(data.error);
                        }
                    })
                    .catch(error => console.error('Error toggling compare:', error));
                });
            });

            // Handle Compare Players button
            const comparePlayersBtn = document.getElementById('compare-players-btn');
            const compareContainer = document.getElementById('compare-container');
            const closeCompareBtn = document.getElementById('close-compare-btn');
            const compareMessage = document.getElementById('compare-message');
            const chartWrapper = document.getElementById('chart-wrapper');
            const compareChartCanvas = document.getElementById('compareChart');

            if (comparePlayersBtn) {
                comparePlayersBtn.addEventListener('click', function() {
                    // Toggle visibility
                    if (compareContainer.style.display === 'none') {
                        compareContainer.style.display = 'block';
                        loadCompareData();
                    } else {
                        compareContainer.style.display = 'none';
                    }
                });
            }

            if (closeCompareBtn) {
                closeCompareBtn.addEventListener('click', function() {
                    compareContainer.style.display = 'none';
                });
            }

            function loadCompareData() {
                fetch("{% url 'get_compare_data' %}", {
                    method: 'GET',
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Compare data response:', data);
                    if (data.success) {
                        compareMessage.style.display = 'none';
                        chartWrapper.style.display = 'block';
                        renderCompareChart(data.data, data.categories, data.labels || null);
                    } else {
                        // Show message but keep chart if it exists
                        compareMessage.style.display = 'block';
                        compareMessage.textContent = data.error || 'Select 2 players to compare';
                        // Only hide canvas if we're destroying the chart
                        if (compareChart) {
                            compareChart.destroy();
                            compareChart = null;
                            chartWrapper.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading compare data:', error);
                    compareMessage.style.display = 'block';
                    compareMessage.textContent = 'Error loading comparison data';
                });
            }

            function renderCompareChart(playersData, categories, categoryLabels) {
                const ctx = compareChartCanvas.getContext('2d');
                
                // Debug: Log the data
                console.log('Players Data:', playersData);
                console.log('Categories:', categories);
                console.log('Category Labels:', categoryLabels);
                
                // Destroy existing chart if it exists
                if (compareChart) {
                    compareChart.destroy();
                }

                // Use provided labels or clean up category names
                const labels = categoryLabels || categories.map(cat => cat.replace('_RT', '').replace('N', '%'));
                
                // Prepare datasets for each player
                const datasets = playersData.map((player, index) => {
                    const borderColors = ['rgb(54, 162, 235)', 'rgb(255, 99, 132)'];
                    const backgroundColors = ['rgba(54, 162, 235, 0.1)', 'rgba(255, 99, 132, 0.1)'];
                    const playerValues = categories.map(cat => {
                        const rawValue = Number(player.stats[cat]);
                        return Number.isFinite(rawValue) ? rawValue : 0;
                    });
                    
                    return {
                        label: player.name,
                        data: playerValues,
                        fill: false,  // Disable fill to show only lines
                        backgroundColor: backgroundColors[index],
                        borderColor: borderColors[index],
                        borderWidth: 3,
                        pointBackgroundColor: borderColors[index],
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: borderColors[index],
                        pointRadius: 5,
                        pointHoverRadius: 7
                    };
                });

                compareChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        animation: {
                            duration: 0  // Disable animation to avoid flickering
                        }
                    }
                });
                
                console.log('Chart created successfully:', compareChart);
            }
        });
    </script>
{% endblock %}
