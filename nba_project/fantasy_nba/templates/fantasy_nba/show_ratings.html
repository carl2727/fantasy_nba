<!-- templates/fantasy_nba/show_ratings.html -->
{% extends 'fantasy_nba/base.html' %}
{% load static %}
{% load extras %}
{% load fantasy_nba_tags %}
{% block content %}
<!DOCTYPE html>
<style>
    .column-hidden-player-id {
        display: none !important; /* !important to help ensure it overrides other styles if necessary */
    }
</style>
<html>
<head>
</head>
<body>
    <h1 class="header-big">Ratings</h1>

    {% if active_team %}
    <div id="team-position-coverage-container" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; font-size: 0.9em;">
        <strong>Position Coverage:</strong> <span id="position-coverage-text">{{ team_coverage_string|default:"Calculating..." }}</span>
    </div>
    {% endif %}

    <div class="table-controls" style="margin-bottom: 15px; display: flex; align-items: center; gap: 20px;">
        <form method="GET" action="{% url 'show_ratings' %}" id="filter-form" style="display: inline-block; margin-right: 20px;">
            <label for="status-filter">Filter by Status:</label>
            <select name="status_filter" id="status-filter" onchange="document.getElementById('filter-form').submit();">
                {% for value, display_name in status_filter_choices %}
                    <option value="{{ value }}" {% if current_status_filter == value %}selected{% endif %}>{{ display_name }}</option>
                {% endfor %}
            </select>
            {# Hidden fields to preserve sorting when filter changes #}
            {% if sort_by %}<input type="hidden" name="sort_by" value="{{ sort_by }}">{% endif %}
            {% if sort_direction %}<input type="hidden" name="sort_direction" value="{{ sort_direction }}">{% endif %}
            {# No explicit submit button needed if onchange submits the form #}
            {# <button type="submit">Filter</button> #}
        </form>
        <div>
            <label for="name-search">Search by Name:</label>
            <input type="text" id="name-search" placeholder="Enter player name...">
        </div>
    </div>

    <table id="ratings-table" class="styled-table">
        <thead>
            <tr>
                {% for column_key, display_name in column_display_names.items %}
                    <th class="{% if column_key == 'Player_ID' %}column-hidden-player-id{% endif %}">
                        <a href="{% url 'sort_ratings' %}?sort_by={{ column_key }}{% if current_status_filter and current_status_filter != 'ALL' %}&status_filter={{ current_status_filter|urlencode }}{% endif %}">
                            {{ display_name }}
                            {% if sort_by == column_key and sort_direction == 'asc' %} ▲{% endif %}
                            {% if sort_by == column_key and sort_direction == 'desc' %} ▼{% endif %}
                        </a>
                    </th>
                {% endfor %}
                <th>
                    {% if active_team %}
                        Actions <!-- Changed from active_team.name for clarity -->
                    {% else %}
                        Tools
                    {% endif %}
                </th>
            </tr>
        </thead>
        <tbody id="ratings-table-body">
            {% if ratings|length == 0 %}
                <tr><td colspan="{{ column_display_names|length|add:'1' }}">No ratings available</td></tr>
            {% else %}
                {% for row in ratings %}
                {% with player_id_val=row|get_item:'Player_ID'|get_item:'value'|default_if_none:'' %}
                <tr data-player-id="{{ player_id_val }}">
                    {% for column_actual_name, column_display_name_val in column_display_names.items %}
                        {% with cell_data=row|get_item:column_actual_name %} {# Each cell_data is {'value': ..., 'css_class': ...} #}
                            <td data-column-key="{{ column_actual_name }}" class="{% if cell_data.css_class %}{{ cell_data.css_class }}{% endif %}{% if column_actual_name == 'Status' %} player-status-cell{% endif %}{% if column_actual_name == 'Player_ID' %} column-hidden-player-id{% endif %}">
                                {% if column_actual_name == "Name" or column_actual_name == "Player_ID" or column_actual_name == "TEAM_ID" or column_actual_name == "Status" or column_actual_name == "POS" %}
                                    {{ cell_data.value }}
                                {% else %}
                                    {{ cell_data.value|floatformat:2|default:"N/A" }}
                                {% endif %}
                            </td>
                        {% endwith %}
                    {% endfor %}
                    <td>
                        {% if player_id_val == 'TEAM_AVERAGE_ROW' %}
                            N/A {# No actions for the team average row #}
                        {% else %}
                            {# Add a class to the forms for easier selection in JS #}
                            {% if user.is_authenticated and active_team %}
                                <!-- Button to set status to ON_TEAM -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="ON_TEAM">
                                    <button type="submit" title="Add to Team">+</button>
                                </form>
                                <!-- Button to set status to AVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="AVAILABLE">
                                    <button type="submit" title="Make Available">-</button>
                                </form>
                                <!-- Button to set status to UNAVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="UNAVAILABLE">
                                    <button type="submit" title="Make Unavailable">/</button>
                                </form>
                            {% else %}
                                <!-- Optional: Message if no active team or user not authenticated -->
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            {% endif %}
        </tbody>
    </table>

    
</body>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const forms = document.querySelectorAll('.update-status-form');

            forms.forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault(); // Prevent default page reload

                    const formData = new FormData(form);
                    const playerId = formData.get('player_id');
                    const newStatusValue = formData.get('status'); // This is 'ON_TEAM', 'AVAILABLE', etc.
                    const url = form.action;
                    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        body: formData, // FormData handles content type for you
                        headers: {
                            // 'X-CSRFToken': csrfToken, // FormData sends it, but good to be aware
                            // For non-FormData POSTs, you'd need:
                            // 'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Try to get error message from server if available
                            return response.json().then(errData => {
                                throw new Error(errData.error || `Server error: ${response.status}`);
                            }).catch(() => {
                                // Fallback if error response is not JSON
                                throw new Error(`Server error: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Find the player's row using the data-player-id attribute
                            const playerRow = document.querySelector(`tr[data-player-id="${playerId}"]`);
                            if (playerRow) {
                                // Find the status cell within that row
                                const statusCell = playerRow.querySelector('.player-status-cell');
                                if (statusCell) {
                                    // Update the cell content with the display name of the new status
                                    statusCell.textContent = data.new_status_display;
                                    // You could also add a temporary success class for visual feedback
                                    // statusCell.classList.add('status-updated');
                                    // setTimeout(() => {
                                    //     statusCell.classList.remove('status-updated');
                                    // }, 1500);
                                } else {
                                    console.error('Status cell not found for player:', playerId);
                                }
                            } else {
                                console.error('Player row not found for player:', playerId);
                            }

                            // Update Team Averages Row if data is present
                            if (typeof data.num_players_on_team !== 'undefined') {
                                const teamAvgRow = document.querySelector('tr[data-player-id="TEAM_AVERAGE_ROW"]');
                                if (teamAvgRow) {
                                    // Update Status cell in Team Average Row
                                    const statusCellInAvgRow = teamAvgRow.querySelector('td[data-column-key="Status"]');
                                    if (statusCellInAvgRow) {
                                        if (data.num_players_on_team > 0) {
                                            statusCellInAvgRow.textContent = `Team Avg (${data.num_players_on_team} Player${data.num_players_on_team !== 1 ? 's' : ''})`;
                                        } else {
                                            statusCellInAvgRow.textContent = 'Team Avg (0 Players)';
                                        }
                                    }

                                    // Update individual stat cells in Team Average Row
                                    if (data.team_averages_data) { // This is the dict of styled averages
                                        for (const col_key in data.team_averages_data) {
                                            const avg_cell_value_obj = data.team_averages_data[col_key]; // {'value': X, 'css_class': Y}
                                            const targetCell = teamAvgRow.querySelector(`td[data-column-key="${col_key}"]`);
                                            if (targetCell) {
                                                let preservedClasses = '';
                                                if (targetCell.classList.contains('column-hidden-player-id')) {
                                                    preservedClasses = 'column-hidden-player-id';
                                                }
                                                targetCell.className = preservedClasses; // Reset data-driven classes, keep structural ones

                                                if (avg_cell_value_obj.value !== null && typeof avg_cell_value_obj.value !== 'undefined') {
                                                    targetCell.textContent = parseFloat(avg_cell_value_obj.value).toFixed(2);
                                                } else {
                                                    targetCell.textContent = "N/A";
                                                }
                                                if (avg_cell_value_obj.css_class) {
                                                    targetCell.classList.add(avg_cell_value_obj.css_class);
                                                }
                                            }
                                        }
                                    } else { // num_players_on_team is 0, team_averages_data is null
                                        // Clear out stat cells to N/A
                                        teamAvgRow.querySelectorAll('td').forEach(cell => {
                                            const cellColKey = cell.getAttribute('data-column-key');
                                            if (cellColKey && !['Name', 'Player_ID', 'Status'].includes(cellColKey)) {
                                                let preservedClasses = ''; // e.g. column-hidden-player-id if it were a stat cell
                                                // For stat cells, usually no special structural classes other than what data-column-key implies
                                                cell.className = preservedClasses;
                                                cell.textContent = 'N/A';
                                            }
                                        });
                                    }
                                }
                            }

                            // Update Position Coverage display
                            if (data.team_coverage_string) {
                                const coverageTextElement = document.getElementById('position-coverage-text');
                                if (coverageTextElement) {
                                    coverageTextElement.textContent = data.team_coverage_string;
                                }
                            }
                            // Optionally, display data.message to the user (e.g., in a toast notification)
                            // console.log(data.message);
                        } else {
                            // Handle failure (e.g., display data.error)
                            alert('Error updating status: ' + (data.error || 'Unknown error'));
                            console.error('Error updating status:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('An error occurred: ' + error.message);
                    });
                });
            });

            // Name Search Functionality
            const nameSearchInput = document.getElementById('name-search');
            const ratingsTableBody = document.getElementById('ratings-table-body');
            const allRows = ratingsTableBody.getElementsByTagName('tr');

            nameSearchInput.addEventListener('keyup', function() {
                const searchTerm = nameSearchInput.value.toLowerCase();

                for (let i = 0; i < allRows.length; i++) {
                    const row = allRows[i];
                    const playerIdVal = row.getAttribute('data-player-id');

                    // Always show the team average row if it exists
                    if (playerIdVal === 'TEAM_AVERAGE_ROW') {
                        row.style.display = ''; // Ensure it's visible
                        continue;
                    }

                    const nameCell = row.querySelector('td[data-column-key="Name"]');
                    if (nameCell) {
                        const nameText = nameCell.textContent.toLowerCase();
                        row.style.display = nameText.includes(searchTerm) ? '' : 'none';
                    }
                }
            });
        });
    </script>
{% endblock %}
