<!-- templates/fantasy_nba/show_ratings.html -->
{% extends 'fantasy_nba/base.html' %}
{% load static %}
{% load extras %}
{% load fantasy_nba_tags %}
{% block content %}
<!DOCTYPE html>
<style>
    .column-hidden-player-id {
        display: none !important; /* !important to help ensure it overrides other styles if necessary */
    }
    tr.row-highlight td { background-color: #fff8d6 !important; }
</style>
<html>
<head>
</head>
<body>
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Player Ratings</h2>
    </div>

    {% if active_team or punt_categories_string %}
    <div id="team-info-container" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; font-size: 0.9em;">
        {% if active_team %}
        <div style="margin-bottom: 5px;">
            <strong>Missing positions:</strong> <span id="position-coverage-text">{{ team_coverage_string|default:"Calculating..." }}</span>
        </div>
        {% endif %}
        {% if punt_categories_string %}
        <div>
            {{ punt_categories_string }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="table-controls" style="margin-bottom: 15px; display: flex; align-items: center; gap: 20px;">
        <form method="GET" action="{% url 'show_ratings' %}" id="filter-form" style="display: inline-block; margin-right: 20px;">
            <label for="status-filter">Filter by Status:</label>
            <select name="status_filter" id="status-filter" onchange="document.getElementById('filter-form').submit();">
                {% for value, display_name in status_filter_choices %}
                    <option value="{{ value }}" {% if current_status_filter == value %}selected{% endif %}>{{ display_name }}</option>
                {% endfor %}
            </select>
            {# Hidden fields to preserve sorting when filter changes #}
            {% if sort_by %}<input type="hidden" name="sort_by" value="{{ sort_by }}">{% endif %}
            {% if sort_direction %}<input type="hidden" name="sort_direction" value="{{ sort_direction }}">{% endif %}
            {# No explicit submit button needed if onchange submits the form #}
            {# <button type="submit">Filter</button> #}
        </form>
        <div>
            <label for="name-search">Search by Name:</label>
            <input type="text" id="name-search" placeholder="Enter player name...">
        </div>
    </div>

    <table id="ratings-table" class="styled-table">
        <thead>
            <tr>
                {% for column_key, display_name in column_display_names.items %}
                    <th class="{% if column_key == 'Player_ID' %}column-hidden-player-id{% endif %}">
                        <a href="{% url 'sort_ratings' %}?sort_by={{ column_key }}&toggle=1{% if current_status_filter and current_status_filter != 'ALL' %}&status_filter={{ current_status_filter|urlencode }}{% endif %}">
                            {{ display_name }}
                            {% if sort_by == column_key and sort_direction == 'asc' %} ▲{% endif %}
                            {% if sort_by == column_key and sort_direction == 'desc' %} ▼{% endif %}
                        </a>
                    </th>
                {% endfor %}
                <th>
                    {% if active_team %}
                        Actions
                    {% else %}
                        Tools
                    {% endif %}
                </th>
            </tr>
        </thead>
        <tbody id="ratings-table-body">
            {% if ratings|length == 0 %}
                <tr><td colspan="{{ column_display_names|length|add:'1' }}">No ratings available</td></tr>
            {% else %}
                {% for row in ratings %}
                {% with player_id_val=row|get_item:'Player_ID'|get_item:'value'|default_if_none:'' %}
                <tr data-player-id="{{ player_id_val }}" class="{% if player_id_val|stringformat:'s' in highlighted_player_ids %}row-highlight{% endif %}">
                    {% for column_actual_name, column_display_name_val in column_display_names.items %}
                        {% with cell_data=row|get_item:column_actual_name %} {# Each cell_data is {'value': ..., 'css_class': ...} #}
                            <td data-column-key="{{ column_actual_name }}"
                                class="{% if enable_heatmap and cell_data.css_class %}{{ cell_data.css_class }}{% endif %}{% if column_actual_name == 'Status' %} player-status-cell{% endif %}{% if column_actual_name == 'Player_ID' %} column-hidden-player-id{% endif %}">
                                {% if column_actual_name == 'Draft_Pos' and active_team and player_id_val != 'TEAM_AVERAGE_ROW' %}
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <button class="draft-move-btn" data-player-id="{{ player_id_val }}" data-direction="up" style="padding: 0 5px; line-height: 1;">+</button>
                                        <span style="flex-grow: 1; text-align: center;">
                                            {{ cell_data.value|default:"N/A" }}
                                        </span>
                                        <button class="draft-move-btn" data-player-id="{{ player_id_val }}" data-direction="down" style="padding: 0 5px; line-height: 1;">-</button>
                                    </div>
                                {% elif player_id_val == 'TEAM_AVERAGE_ROW' and column_actual_name == "Name" %}
                                    {# 1. Bold Team Name #}
                                    <strong>{{ cell_data.value }}</strong>
                                {% elif column_actual_name == "Name" or column_actual_name == "Player_ID" or column_actual_name == "TEAM_ID" or column_actual_name == "Status" or column_actual_name == "POS" %}
                                    {{ cell_data.value }}
                                {% else %}
                                    {{ cell_data.value|floatformat:2|default:"N/A" }}
                                {% endif %}
                            </td>
                        {% endwith %} {# This was missing, closes the 'with cell_data' block #}
                    {% endfor %}
                    <td>
                        {% if player_id_val == 'TEAM_AVERAGE_ROW' %}
                            {# 3. Empty Actions cell for team average row #}
                            
                        {% else %}
                            {# Add a class to the forms for easier selection in JS #}
                            {% if user.is_authenticated and active_team %}
                                <!-- Button to set status to ON_TEAM -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="ON_TEAM">
                                    <button type="submit" title="Add to Team">+</button>
                                </form>
                                <!-- Button to set status to AVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="AVAILABLE">
                                    <button type="submit" title="Make Available">-</button>
                                </form>
                                <!-- Button to set status to UNAVAILABLE -->
                                <form method="post" action="{% url 'update_player_status' %}" class="update-status-form" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="player_id" value="{{ player_id_val }}">
                                    <input type="hidden" name="status" value="UNAVAILABLE">
                                    <button type="submit" title="Make Unavailable">/</button>
                                </form>
                            {% else %}
                                <!-- Optional: Message if no active team or user not authenticated -->
                            {% endif %}
                            {# Highlight-Toggle Button immer anzeigen (authentifizierter Nutzer vorausgesetzt) #}
                            {% if user.is_authenticated %}
                            <button type="button" class="toggle-highlight-btn" data-player-id="{{ player_id_val }}" title="Toggle highlight">
                                {% if player_id_val|stringformat:'s' in highlighted_player_ids %}Unhighlight{% else %}Highlight{% endif %}
                            </button>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            {% endif %}
        </tbody>
    </table>

    
</body>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const forms = document.querySelectorAll('.update-status-form');

            forms.forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault(); // Prevent default page reload

                    const formData = new FormData(form);
                    const playerId = formData.get('player_id');
                    const newStatusValue = formData.get('status'); // This is 'ON_TEAM', 'AVAILABLE', etc.
                    const url = form.action;
                    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        body: formData, // FormData handles content type for you
                        headers: {
                            // 'X-CSRFToken': csrfToken, // FormData sends it, but good to be aware
                            // For non-FormData POSTs, you'd need:
                            // 'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Try to get error message from server if available
                            return response.json().then(errData => {
                                throw new Error(errData.error || `Server error: ${response.status}`);
                            }).catch(() => {
                                // Fallback if error response is not JSON
                                throw new Error(`Server error: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Entferne ggf. vorhandenen toggle-Parameter, um Sortier-Toggle zu verhindern
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.delete('toggle');
                            window.location.replace(currentUrl.toString());
                        } else {
                            // Handle failure (e.g., display data.error)
                            alert('Error updating status: ' + (data.error || 'Unknown error'));
                            console.error('Error updating status:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('An error occurred: ' + error.message);
                    });
                });
            });

            // Draft Position Buttons
            const draftMoveButtons = document.querySelectorAll('.draft-move-btn');
            draftMoveButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();

                    const playerId = this.dataset.playerId;
                    const direction = this.dataset.direction;
                    const url = "{% url 'move_draft_pick' %}";
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    const formData = new FormData();
                    formData.append('player_id', playerId);
                    formData.append('direction', direction);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.delete('toggle');
                            window.location.replace(currentUrl.toString());
                        } else {
                            alert('Error: ' + data.error);
                            console.error('Error moving draft pick:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('A network error occurred.');
                    });
                });
            });

            // Highlight Toggle Buttons
            const highlightButtons = document.querySelectorAll('.toggle-highlight-btn');
            highlightButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();

                    const playerId = this.dataset.playerId;
                    const url = "{% url 'toggle_highlight' %}";
                    const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                    const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

                    const formData = new FormData();
                    formData.append('player_id', playerId);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.delete('toggle');
                            window.location.replace(currentUrl.toString());
                        } else {
                            alert('Error: ' + (data.error || 'Unknown error'));
                            console.error('Error toggling highlight:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('A network error occurred.');
                    });
                });
            });

            // Name Search Functionality
            const nameSearchInput = document.getElementById('name-search');
            const ratingsTableBody = document.getElementById('ratings-table-body');
            const allRows = ratingsTableBody.getElementsByTagName('tr');

            nameSearchInput.addEventListener('keyup', function() {
                const searchTerm = nameSearchInput.value.toLowerCase();

                for (let i = 0; i < allRows.length; i++) {
                    const row = allRows[i];
                    const playerIdVal = row.getAttribute('data-player-id');

                    // Always show the team average row if it exists
                    if (playerIdVal === 'TEAM_AVERAGE_ROW') {
                        row.style.display = ''; // Ensure it's visible
                        continue;
                    }

                    const nameCell = row.querySelector('td[data-column-key="Name"]');
                    if (nameCell) {
                        const nameText = nameCell.textContent.toLowerCase();
                        row.style.display = nameText.includes(searchTerm) ? '' : 'none';
                    }
                }
            });
        });
    </script>
{% endblock %}
